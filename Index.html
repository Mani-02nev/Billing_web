<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AC Duct Billing Suite</title>
  <!-- Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --text:#e2e8f0; --brand:#22d3ee; --brand2:#6366f1;
      --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --border:#1f2937;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(120deg,var(--bg),#0a0f1a);color:var(--text)}
    header{position:sticky;top:0;z-index:40;background:rgba(11,18,32,.75);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
    .container{max-width:1400px;margin:0 auto;padding:24px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:36px;height:36px;border-radius:10px;background:conic-gradient(from 180deg,var(--brand),var(--brand2));box-shadow:0 0 24px rgba(34,211,238,.35)}
    h1{font-size:18px;margin:0}
    .muted{color:var(--muted)}
    nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .tab{cursor:pointer;border:1px solid var(--border);padding:10px 14px;border-radius:12px;background:#0d1628;color:var(--text);transition:.2s}
    .tab.active{background:linear-gradient(135deg,rgba(34,211,238,.15),rgba(99,102,241,.15));border-color:#334155}
    main{padding:24px 16px}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid-2{grid-template-columns:1.3fr .7fr}.grid-3{grid-template-columns:repeat(3,1fr)}}
    .card{background:linear-gradient(180deg,#0e1628,#0b1424);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(2,8,23,.4)}
    .card h2{font-size:18px;margin:0 0 12px}
    .card .body{padding:16px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #1e293b;background:#0a1324;color:var(--text)}
    textarea{min-height:72px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid #1f2937;background:#0d1628;color:var(--text);cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .btn.brand{background:linear-gradient(135deg,rgba(34,211,238,.25),rgba(99,102,241,.25));border-color:#334155}
    .btn.ok{background:rgba(16,185,129,.15);border-color:#0e9f6e}
    .btn.warn{background:rgba(245,158,11,.15);border-color:#b45309}
    .btn.danger{background:rgba(239,68,68,.15);border-color:#b91c1c}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px dashed #233046}
    th{color:#a5b4fc;text-align:left}
    tfoot td{font-weight:700}
    .right{text-align:right}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #334155;color:#a3e635;font-size:12px}
    .flex{display:flex;gap:8px;align-items:center}
    .space{height:8px}
    .hidden{display:none}
    .footer{padding:16px;color:var(--muted);text-align:center;border-top:1px solid var(--border)}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>AC Duct Billing Suite</h1>
          <div class="muted">PO → Invoice → Monthly Sales Reports → Excel Export</div>
        </div>
      </div>
      <nav id="tabs">
        <button class="tab active" data-target="dashboard">Dashboard</button>
        <button class="tab" data-target="masters">Masters</button>
        <button class="tab" data-target="po">Create PO (Seller)</button>
        <button class="tab" data-target="invoice">Create Invoice (Customer)</button>
        <button class="tab" data-target="reports">Reports & Export</button>
        <button class="tab" data-target="settings">Settings</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- DASHBOARD -->
    <section id="dashboard" class="grid grid-2">
      <div class="card">
        <div class="body">
          <h2>Quick Stats</h2>
          <div class="row-3">
            <div>
              <div class="muted">Customers</div>
              <div id="statCustomers" style="font-size:28px;font-weight:700">0</div>
            </div>
            <div>
              <div class="muted">Sellers</div>
              <div id="statSellers" style="font-size:28px;font-weight:700">0</div>
            </div>
            <div>
              <div class="muted">Invoices (This Month)</div>
              <div id="statInvoices" style="font-size:28px;font-weight:700">0</div>
            </div>
          </div>
          <div class="space"></div>
          <div class="row">
            <button class="btn brand" onclick="goTab('invoice')">+ New Invoice</button>
            <button class="btn" onclick="goTab('po')">+ New PO</button>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="body">
          <h2>Today</h2>
          <div id="todayBox" class="muted"></div>
          <div class="space"></div>
          <div class="pill" id="companyNamePill">Your Company</div>
        </div>
      </div>
    </section>

    <!-- MASTERS -->
    <section id="masters" class="hidden">
      <div class="grid grid-3">
        <div class="card">
          <div class="body">
            <h2>Customers</h2>
            <div class="row">
              <div>
                <label>Name</label>
                <input id="custName" placeholder="Customer Name" />
              </div>
              <div>
                <label>Phone</label>
                <input id="custPhone" placeholder="Phone" />
              </div>
            </div>
            <label>Billing Address</label>
            <textarea id="custAddr" placeholder="Street, City, PIN"></textarea>
            <div class="row">
              <div>
                <label>GSTIN (optional)</label>
                <input id="custGST" placeholder="27ABCDE1234F1Z5" />
              </div>
              <div>
                <label>Email (optional)</label>
                <input id="custEmail" placeholder="customer@email.com" />
              </div>
            </div>
            <div class="space"></div>
            <button class="btn ok" onclick="addCustomer()">Add Customer</button>
            <div class="space"></div>
            <table>
              <thead><tr><th>Name</th><th>Phone</th><th class="right">Actions</th></tr></thead>
              <tbody id="custTable"></tbody>
            </table>
          </div>
        </div>
        <div class="card">
          <div class="body">
            <h2>Sellers</h2>
            <div class="row">
              <div>
                <label>Name</label>
                <input id="sellName" placeholder="Seller / Vendor" />
              </div>
              <div>
                <label>Phone</label>
                <input id="sellPhone" placeholder="Phone" />
              </div>
            </div>
            <label>Address</label>
            <textarea id="sellAddr" placeholder="Street, City, PIN"></textarea>
            <div class="row">
              <div>
                <label>GSTIN (optional)</label>
                <input id="sellGST" placeholder="27ABCDE1234F1Z5" />
              </div>
              <div>
                <label>Email (optional)</label>
                <input id="sellEmail" placeholder="seller@email.com" />
              </div>
            </div>
            <div class="space"></div>
            <button class="btn ok" onclick="addSeller()">Add Seller</button>
            <div class="space"></div>
            <table>
              <thead><tr><th>Name</th><th>Phone</th><th class="right">Actions</th></tr></thead>
              <tbody id="sellTable"></tbody>
            </table>
          </div>
        </div>
        <div class="card">
          <div class="body">
            <h2>Products</h2>
            <div class="row">
              <div>
                <label>Item Name</label>
                <input id="prodName" placeholder="e.g., GI Duct 24G" />
              </div>
              <div>
                <label>Unit</label>
                <input id="prodUnit" placeholder="e.g., sq.ft / meter / nos" />
              </div>
            </div>
            <div class="row">
              <div>
                <label>Unit Price (₹)</label>
                <input id="prodPrice" type="number" step="0.01" placeholder="0.00" />
              </div>
              <div>
                <label>GST %</label>
                <input id="prodGST" type="number" step="0.1" placeholder="18" />
              </div>
            </div>
            <div class="space"></div>
            <button class="btn ok" onclick="addProduct()">Add Product</button>
            <div class="space"></div>
            <table>
              <thead><tr><th>Item</th><th>Unit</th><th>Price</th><th>GST%</th><th class="right">Actions</th></tr></thead>
              <tbody id="prodTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- PO -->
    <section id="po" class="hidden">
      <div class="grid grid-2">
        <div class="card">
          <div class="body">
            <h2>Create Purchase Order (PO)</h2>
            <div class="row">
              <div>
                <label>PO Date</label>
                <input id="poDate" type="date" />
              </div>
              <div>
                <label>Seller</label>
                <select id="poSeller"></select>
              </div>
            </div>
            <label>Reference / Notes</label>
            <input id="poRef" placeholder="Optional reference" />

            <div class="space"></div>
            <h3 style="margin:0 0 8px">Items</h3>
            <table>
              <thead><tr><th style="width:34%">Product</th><th>Qty</th><th>Unit</th><th>Rate</th><th class="right">Amount</th><th></th></tr></thead>
              <tbody id="poItems"></tbody>
              <tfoot>
                <tr><td colspan="6"><button class="btn" onclick="addPOItemRow()">+ Add Item</button></td></tr>
              </tfoot>
            </table>
            <div class="row">
              <div></div>
              <div>
                <div class="muted">Subtotal</div>
                <div id="poSubtotal" class="right">₹0.00</div>
                <div class="muted">Estimated GST</div>
                <div id="poGST" class="right">₹0.00</div>
                <div class="muted">Grand Total</div>
                <div id="poTotal" class="right" style="font-size:20px;font-weight:700">₹0.00</div>
              </div>
            </div>
            <div class="space"></div>
            <div class="row">
              <button class="btn ok" onclick="savePO()">Save PO</button>
              <button class="btn brand" onclick="downloadPOPDF()">Download PO PDF</button>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="body">
            <h2>Saved POs</h2>
            <table>
              <thead><tr><th>#</th><th>Date</th><th>Seller</th><th class="right">Total</th><th></th></tr></thead>
              <tbody id="poList"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- INVOICE -->
    <section id="invoice" class="hidden">
      <div class="grid grid-2">
        <div class="card">
          <div class="body">
            <h2>Create Invoice</h2>
            <div class="row">
              <div>
                <label>Invoice Date</label>
                <input id="invDate" type="date" />
              </div>
              <div>
                <label>Customer</label>
                <select id="invCustomer"></select>
              </div>
            </div>
            <div class="row">
              <div>
                <label>Invoice #</label>
                <input id="invNumber" placeholder="INV-001" />
              </div>
              <div>
                <label>Due Days</label>
                <input id="invDue" type="number" placeholder="7" />
              </div>
            </div>

            <div class="space"></div>
            <h3 style="margin:0 0 8px">Items</h3>
            <table>
              <thead><tr><th style="width:34%">Product</th><th>Qty</th><th>Unit</th><th>Rate</th><th>GST%</th><th class="right">Amount</th><th></th></tr></thead>
              <tbody id="invItems"></tbody>
              <tfoot>
                <tr><td colspan="7"><button class="btn" onclick="addInvItemRow()">+ Add Item</button></td></tr>
              </tfoot>
            </table>
            <div class="row">
              <div></div>
              <div>
                <div class="muted">Subtotal</div>
                <div id="invSubtotal" class="right">₹0.00</div>
                <div class="muted">GST</div>
                <div id="invGST" class="right">₹0.00</div>
                <div class="muted">Grand Total</div>
                <div id="invTotal" class="right" style="font-size:20px;font-weight:700">₹0.00</div>
              </div>
            </div>
            <div class="space"></div>
            <div class="row">
              <button class="btn ok" onclick="saveInvoice()">Save Invoice</button>
              <button class="btn brand" onclick="downloadInvoicePDF()">Download Invoice PDF</button>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="body">
            <h2>Saved Invoices</h2>
            <table>
              <thead><tr><th>#</th><th>Date</th><th>Customer</th><th class="right">Total</th><th></th></tr></thead>
              <tbody id="invList"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- REPORTS -->
    <section id="reports" class="hidden">
      <div class="grid">
        <div class="card">
          <div class="body">
            <h2>Monthly Sales Report</h2>
            <div class="row">
              <div>
                <label>Month</label>
                <input id="repMonth" type="month" />
              </div>
              <div style="align-self:end">
                <button class="btn" onclick="loadMonthly()">Generate</button>
              </div>
              <div style="align-self:end">
                <button class="btn brand" onclick="exportMonthlyExcel()">Export Month to Excel</button>
              </div>
              <div style="align-self:end">
                <button class="btn" onclick="exportAllExcel()">Export All → Excel</button>
              </div>
            </div>
            <div class="space"></div>
            <table>
              <thead><tr><th>Date</th><th>Invoice #</th><th>Customer</th><th class="right">Subtotal</th><th class="right">GST</th><th class="right">Total</th></tr></thead>
              <tbody id="repTable"></tbody>
              <tfoot>
                <tr><td colspan="3" class="right">Totals</td><td id="repSub" class="right">₹0.00</td><td id="repGST" class="right">₹0.00</td><td id="repTot" class="right">₹0.00</td></tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="settings" class="hidden">
      <div class="grid">
        <div class="card"><div class="body">
          <h2>Company Profile</h2>
          <div class="row">
            <div>
              <label>Company Name</label>
              <input id="cfgName" placeholder="Your Company Pvt Ltd" />
            </div>
            <div>
              <label>GSTIN</label>
              <input id="cfgGST" placeholder="27ABCDE1234F1Z5" />
            </div>
          </div>
          <label>Address</label>
          <textarea id="cfgAddr" placeholder="Street, City, State, PIN"></textarea>
          <div class="row">
            <div>
              <label>Phone</label>
              <input id="cfgPhone" placeholder="+91-" />
            </div>
            <div>
              <label>Email</label>
              <input id="cfgEmail" placeholder="info@company.com" />
            </div>
          </div>
          <div class="space"></div>
          <button class="btn ok" onclick="saveConfig()">Save Profile</button>
        </div></div>
      </div>
    </section>
  </main>

  <div class="footer">Local-first • Data stored in your browser • Export to PDF / Excel anytime</div>

  <script>
    // ---------- Storage ----------
    const LS_KEY = 'acDuctBillingData.v1';
    const blank = () => ({
      config:{name:'Your Company', address:'', phone:'', email:'', gst:''},
      customers:[], sellers:[], products:[],
      pos:[], invoices:[]
    });
    function load(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY)) || blank(); }catch(e){ return blank(); }
    }
    function save(db){ localStorage.setItem(LS_KEY, JSON.stringify(db)); renderAll(); }
    let db = load();

    // ---------- Helpers ----------
    const rs = n => '₹'+(Number(n||0).toFixed(2));
    const byId = id => document.getElementById(id);
    const todayISO = () => new Date().toISOString().slice(0,10);
    const uid = () => Math.random().toString(36).slice(2,9);
    function setOptions(sel, arr, labelKey='name'){
      sel.innerHTML = '<option value="">-- Select --</option>' + arr.map((x,i)=>`<option value="${i}">${x[labelKey]}</option>`).join('');
    }

    // ---------- Tabs ----------
    function goTab(id){
      document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.dataset.target===id));
      document.querySelectorAll('main section').forEach(s=>s.classList.add('hidden'));
      byId(id).classList.remove('hidden');
      if(id==='reports') autoMonth();
    }
    document.querySelectorAll('#tabs .tab').forEach(t=>t.addEventListener('click',()=>goTab(t.dataset.target)));

    // ---------- Masters: Customers ----------
    function addCustomer(){
      const name = byId('custName').value.trim();
      if(!name) return alert('Enter customer name');
      db.customers.push({
        id: uid(), name,
        phone: byId('custPhone').value.trim(),
        address: byId('custAddr').value.trim(),
        gst: byId('custGST').value.trim(),
        email: byId('custEmail').value.trim()
      });
      save(db);
      byId('custName').value=byId('custPhone').value=byId('custAddr').value='';
      byId('custGST').value=byId('custEmail').value='';
    }
    function delCustomer(i){ db.customers.splice(i,1); save(db); }
    function drawCustomers(){
      byId('custTable').innerHTML = db.customers.map((c,i)=>`
        <tr><td>${c.name}</td><td>${c.phone||''}</td>
        <td class='right'><button class='btn danger' onclick='delCustomer(${i})'>Delete</button></td></tr>`).join('');
      setOptions(byId('invCustomer'), db.customers);
    }

    // ---------- Masters: Sellers ----------
  function addProduct(){
      const name = byId('prodName').value.trim();
      if(!name) return alert('Enter product name');
      const unit = byId('prodUnit').value.trim();
      const price = Number(byId('prodPrice').value||0);
      const gst = Number(byId('prodGST').value||0);
      db.products.push({id:uid(), name, unit, price, gst});
      save(db);
      byId('prodName').value=byId('prodUnit').value=byId('prodPrice').value=byId('prodGST').value='';
    }
    function delProduct(i){ db.products.splice(i,1); save(db); }
    function drawProducts(){
      byId('prodTable').innerHTML = db.products.map((p,i)=>`
        <tr><td>${p.name}</td><td>${p.unit}</td><td>${rs(p.price)}</td><td>${p.gst||0}%</td>
        <td class='right'><button class='btn danger' onclick='delProduct(${i})'>Delete</button></td></tr>`).join('');
    }

    // ---------- PO Form ----------
    function addPOItemRow(){
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><select class='po-prod'></select></td>
        <td><input class='po-qty' type='number' step='0.01' value='1' /></td>
        <td class='po-unit muted'></td>
        <td class='po-rate muted right'></td>
        <td class='po-amt right'>₹0.00</td>
        <td><button class='btn warn' onclick='this.closest("tr").remove(); calcPO()'>Remove</button></td>`;
      byId('poItems').appendChild(tr);
      const sel = tr.querySelector('.po-prod');
      sel.innerHTML = '<option value="">Select product</option>' + db.products.map((p,i)=>`<option value='${i}'>${p.name}</option>`).join('');
      sel.onchange=()=>fillPOProd(tr, sel.value);
      tr.querySelector('.po-qty').oninput=calcPO;
    }
    function fillPOProd(tr, idx){
      if(idx==='') return; const p=db.products[idx];
      tr.dataset.idx=idx;
      tr.querySelector('.po-unit').textContent=p.unit||'';
      tr.querySelector('.po-rate').textContent=rs(p.price);
      calcPO();
    }
    function calcPO(){
      let sub=0, tax=0;
      byId('poItems').querySelectorAll('tr').forEach(tr=>{
        const i = tr.dataset.idx; if(i===undefined) return;
        const p = db.products[i]; const qty = Number(tr.querySelector('.po-qty').value||0);
        const amt = qty * (p?.price||0);
        tr.querySelector('.po-amt').textContent = rs(amt);
        sub += amt; tax += amt * (p?.gst||0)/100;
      });
      byId('poSubtotal').textContent = rs(sub);
      byId('poGST').textContent = rs(tax);
      byId('poTotal').textContent = rs(sub+tax);
    }
    function savePO(){
      const sellerIdx = byId('poSeller').value; if(sellerIdx==='') return alert('Select seller');
      const items=[];
      byId('poItems').querySelectorAll('tr').forEach(tr=>{
        const i = tr.dataset.idx; if(i===undefined) return;
        const p = db.products[i]; const qty = Number(tr.querySelector('.po-qty').value||0);
        items.push({product:p.name, unit:p.unit, rate:p.price, gst:p.gst, qty, amount: qty*p.price});
      });
      if(!items.length) return alert('Add at least one item');
      const po={ id:uid(), date: byId('poDate').value||todayISO(), seller: db.sellers[sellerIdx], ref: byId('poRef').value.trim(),
        items, subtotal:sum(items.map(x=>x.amount)), gst:sum(items.map(x=>x.amount*x.gst/100)), total:0 };
      po.total = po.subtotal + po.gst;
      db.pos.unshift(po); save(db);
      drawPOs();
      alert('PO saved');
    }

    // ---------- Invoice Form ----------
    function addInvItemRow(){
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><select class='inv-prod'></select></td>
        <td><input class='inv-qty' type='number' step='0.01' value='1' /></td>
        <td class='inv-unit muted'></td>
        <td class='inv-rate muted right'></td>
        <td><input class='inv-gst' type='number' step='0.1' value='18' style='width:80px' /></td>
        <td class='inv-amt right'>₹0.00</td>
        <td><button class='btn warn' onclick='this.closest("tr").remove(); calcInv()'>Remove</button></td>`;
      byId('invItems').appendChild(tr);
      const sel = tr.querySelector('.inv-prod');
      sel.innerHTML = '<option value="">Select product</option>' + db.products.map((p,i)=>`<option value='${i}'>${p.name}</option>`).join('');
      sel.onchange=()=>fillInvProd(tr, sel.value);
      tr.querySelector('.inv-qty').oninput=calcInv;
      tr.querySelector('.inv-gst').oninput=calcInv;
    }
    function fillInvProd(tr, idx){
      if(idx==='') return; const p=db.products[idx];
      tr.dataset.idx=idx;
      tr.querySelector('.inv-unit').textContent=p.unit||'';
      tr.querySelector('.inv-rate').textContent=rs(p.price);
      tr.querySelector('.inv-gst').value = p.gst||0;
      calcInv();
    }
    function calcInv(){
      let sub=0, tax=0;
      byId('invItems').querySelectorAll('tr').forEach(tr=>{
        const i = tr.dataset.idx; if(i===undefined) return;
        const p = db.products[i]; const qty = Number(tr.querySelector('.inv-qty').value||0);
        const gst = Number(tr.querySelector('.inv-gst').value||0);
        const rate = p?.price||0; const amt = qty*rate; const gstAmt=amt*gst/100;
        tr.querySelector('.inv-amt').textContent = rs(amt+gstAmt);
        sub += amt; tax += gstAmt;
      });
      byId('invSubtotal').textContent = rs(sub);
      byId('invGST').textContent = rs(tax);
      byId('invTotal').textContent = rs(sub+tax);
    }
    function saveInvoice(){
      const custIdx = byId('invCustomer').value; if(custIdx==='') return alert('Select customer');
      const items=[];
      byId('invItems').querySelectorAll('tr').forEach(tr=>{
        const i = tr.dataset.idx; if(i===undefined) return;
        const p = db.products[i]; const qty = Number(tr.querySelector('.inv-qty').value||0);
        const gst = Number(tr.querySelector('.inv-gst').value||0);
        items.push({product:p.name, unit:p.unit, rate:p.price, gst, qty, amount: qty*p.price, gstAmount: qty*p.price*gst/100});
      });
      if(!items.length) return alert('Add at least one item');
      const inv={ id:uid(), number: byId('invNumber').value || autoInvNumber(), date: byId('invDate').value||todayISO(),
        dueDays: Number(byId('invDue').value||7), customer: db.customers[custIdx], items,
        subtotal: sum(items.map(x=>x.amount)), gst: sum(items.map(x=>x.gstAmount)), total:0 };
      inv.total = inv.subtotal + inv.gst;
      db.invoices.unshift(inv); save(db);
      drawInvoices();
      alert('Invoice saved');
    }

    // ---------- Lists ----------
    function drawPOs(){
      byId('poList').innerHTML = db.pos.map((p,i)=>`
        <tr><td>${i+1}</td><td>${p.date}</td><td>${p.seller?.name||''}</td><td class='right'>${rs(p.total)}</td>
        <td class='right'><button class='btn' onclick='downloadPOPDF(${JSON.stringify(p.id)})'>PDF</button></td></tr>`).join('');
    }
    function drawInvoices(){
      byId('invList').innerHTML = db.invoices.map((v,i)=>`
        <tr><td>${v.number}</td><td>${v.date}</td><td>${v.customer?.name||''}</td><td class='right'>${rs(v.total)}</td>
        <td class='right'><button class='btn' onclick='downloadInvoicePDF(${JSON.stringify(v.id)})'>PDF</button></td></tr>`).join('');
    }

    // ---------- Reports ----------
    function autoMonth(){
      if(!byId('repMonth').value){
        const d=new Date();const m=('0'+(d.getMonth()+1)).slice(-2); byId('repMonth').value=`${d.getFullYear()}-${m}`;
      }
      loadMonthly();
    }
    function loadMonthly(){
      const ym = byId('repMonth').value; if(!ym) return;
      const [yy,mm] = ym.split('-').map(Number);
      const list = db.invoices.filter(v=>{
        const d=new Date(v.date); return d.getFullYear()===yy && (d.getMonth()+1)===mm; });
      let sub=0,gst=0,tot=0;
      byId('repTable').innerHTML = list.map(v=>{
        sub+=v.subtotal; gst+=v.gst; tot+=v.total;
        return `<tr><td>${v.date}</td><td>${v.number}</td><td>${v.customer?.name||''}</td>
          <td class='right'>${rs(v.subtotal)}</td><td class='right'>${rs(v.gst)}</td><td class='right'>${rs(v.total)}</td></tr>`;
      }).join('');
      byId('repSub').textContent=rs(sub); byId('repGST').textContent=rs(gst); byId('repTot').textContent=rs(tot);
      byId('statInvoices').textContent=String(list.length);
    }

    // ---------- Export: Excel ----------
    function aoaFrom(arr, headers){ return [headers, ...arr.map(o=>headers.map(h=>o[h]??''))]; }
    function exportAllExcel(){
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(aoaFrom(db.customers,["name","phone","email","gst","address"])), 'Customers');
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(aoaFrom(db.sellers,["name","phone","email","gst","address"])), 'Sellers');
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(db.products.length?[
        ['Item','Unit','Rate','GST%'],...db.products.map(p=>[p.name,p.unit,p.price,p.gst])]:[['No Products']]), 'Products');
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(db.pos.length?[
        ['PO Date','Seller','Subtotal','GST','Total','Ref'],...db.pos.map(p=>[p.date,p.seller?.name,p.subtotal,p.gst,p.total,p.ref])]:[['No POs']]), 'POs');
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(db.invoices.length?[
        ['Date','Invoice#','Customer','Subtotal','GST','Total'],...db.invoices.map(v=>[v.date,v.number,v.customer?.name,v.subtotal,v.gst,v.total])]:[['No Invoices']]), 'Invoices');
      XLSX.writeFile(wb, `AC-Duct-Billing-All-${new Date().toISOString().slice(0,10)}.xlsx`);
    }
    function exportMonthlyExcel(){
      const ym = byId('repMonth').value; if(!ym) return alert('Choose month');
      const [yy,mm] = ym.split('-').map(Number);
      const list = db.invoices.filter(v=>{ const d=new Date(v.date); return d.getFullYear()===yy && (d.getMonth()+1)===mm; });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(list.length?[
        ['Date','Invoice#','Customer','Subtotal','GST','Total'],...list.map(v=>[v.date,v.number,v.customer?.name,v.subtotal,v.gst,v.total])]:[['No Data']]), 'Monthly Sales');
      XLSX.writeFile(wb, `Sales-${ym}.xlsx`);
    }

    // ---------- Export: PDF (PO & Invoice) ----------
    function companyHeader(doc, cfg){
      doc.setFontSize(14); doc.text(cfg.name||'Your Company', 14, 16);
      doc.setFontSize(9);
      doc.text((cfg.address||'') + (cfg.phone?`\nPhone: ${cfg.phone}`:'') + (cfg.email?`\nEmail: ${cfg.email}`:'') + (cfg.gst?`\nGSTIN: ${cfg.gst}`:''), 14, 22);
    }
    function tableAuto(doc, head, body, startY){ doc.autoTable({ head:[head], body, startY, theme:'grid', styles:{fontSize:9}, headStyles:{fillColor:[15,22,40]} }); }

    function currentPOForPDF(id){
      return typeof id==='string' ? db.pos.find(x=>x.id===id) : db.pos[0];
    }
    function currentInvForPDF(id){
      return typeof id==='string' ? db.invoices.find(x=>x.id===id) : db.invoices[0];
    }

    function downloadPOPDF(id){
      const po = currentPOForPDF(id);
      if(!po){ return alert('No PO found'); }
      const { jsPDF } = window.jspdf; const doc = new jsPDF();
      companyHeader(doc, db.config);
      doc.setFontSize(16); doc.text('PURCHASE ORDER', 200-14, 16, {align:'right'});
      doc.setFontSize(10);
      const s = po.seller||{};
      const sellerBlock = `Seller:\n${s.name||''}\n${s.address||''}\nGSTIN: ${s.gst||''}`;
      const metaBlock = `PO Date: ${po.date}\nReference: ${po.ref||'-'}`;
      doc.text(sellerBlock, 14, 60);
      doc.text(metaBlock, 200-14, 60, {align:'right'});

      const body = po.items.map((x,i)=>[i+1, x.product, x.qty+' '+(x.unit||''), x.rate, x.gst+'%', (x.amount||0), (x.amount||0)*(x.gst||0)/100, (x.amount||0)*(1+(x.gst||0)/100)]);
      tableAuto(doc, ['#','Item','Qty','Rate','GST%','Amount','GST Amt','Total'], body, 80);
      const y = doc.lastAutoTable.finalY + 6;
      doc.setFontSize(12);
      doc.text(`Subtotal: ${rs(po.subtotal)}`, 200-14, y, {align:'right'});
      doc.text(`GST: ${rs(po.gst)}`, 200-14, y+6, {align:'right'});
      doc.text(`Grand Total: ${rs(po.total)}`, 200-14, y+12, {align:'right'});
      doc.save(`PO-${po.date}-${(s.name||'seller').replace(/\s+/g,'_')}.pdf`);
    }

    function downloadInvoicePDF(id){
      const inv = currentInvForPDF(id);
      if(!inv){ return alert('No invoice found'); }
      const { jsPDF } = window.jspdf; const doc = new jsPDF();
      companyHeader(doc, db.config);
      doc.setFontSize(16); doc.text('TAX INVOICE', 200-14, 16, {align:'right'});
      doc.setFontSize(10);
      const c = inv.customer||{};
      const custBlock = `Bill To:\n${c.name||''}\n${c.address||''}\nGSTIN: ${c.gst||''}`;
      const metaBlock = `Invoice#: ${inv.number}\nDate: ${inv.date}\nDue in: ${inv.dueDays} days`;
      doc.text(custBlock, 14, 60);
      doc.text(metaBlock, 200-14, 60, {align:'right'});

      const body = inv.items.map((x,i)=>[i+1, x.product, x.qty+' '+(x.unit||''), x.rate, x.gst+'%', x.amount, x.gstAmount, x.amount + x.gstAmount]);
      tableAuto(doc, ['#','Item','Qty','Rate','GST%','Amount','GST Amt','Total'], body, 80);
      const y = doc.lastAutoTable.finalY + 6;
      doc.setFontSize(12);
      doc.text(`Subtotal: ${rs(inv.subtotal)}`, 200-14, y, {align:'right'});
      doc.text(`GST: ${rs(inv.gst)}`, 200-14, y+6, {align:'right'});
      doc.text(`Grand Total: ${rs(inv.total)}`, 200-14, y+12, {align:'right'});
      doc.save(`${inv.number}-${(c.name||'customer').replace(/\s+/g,'_')}.pdf`);
    }

    // ---------- Config ----------
    function saveConfig(){
      db.config.name = byId('cfgName').value || 'Your Company';
      db.config.address = byId('cfgAddr').value || '';
      db.config.phone = byId('cfgPhone').value || '';
      db.config.email = byId('cfgEmail').value || '';
      db.config.gst = byId('cfgGST').value || '';
      save(db); alert('Saved company profile');
    }

    // ---------- Utils ----------
    const sum = arr => arr.reduce((a,b)=>a+Number(b||0),0);
    function autoInvNumber(){
      const n = (db.invoices[0]?.number || 'INV-000');
      const m = n.match(/(\d+)$/); const next = (m?parseInt(m[1],10):0)+1; return 'INV-'+String(next).padStart(3,'0');
    }

    // ---------- Render ----------
    function renderAll(){
      drawCustomers(); drawSellers(); drawProducts(); drawPOs(); drawInvoices(); loadMonthly();
      byId('poDate').value = todayISO(); byId('invDate').value=todayISO();
      byId('todayBox').textContent = new Date().toLocaleString();
      byId('companyNamePill').textContent = db.config.name || 'Your Company';
      byId('cfgName').value=db.config.name||''; byId('cfgAddr').value=db.config.address||'';
      byId('cfgPhone').value=db.config.phone||''; byId('cfgEmail').value=db.config.email||''; byId('cfgGST').value=db.config.gst||'';
      byId('statCustomers').textContent = String(db.customers.length);
      byId('statSellers').textContent = String(db.sellers.length);
      // refresh product selects on new rows
      document.querySelectorAll('.po-prod').forEach(sel=> sel.innerHTML = '<option value="">Select product</option>' + db.products.map((p,i)=>`<option value='${i}'>${p.name}</option>`).join(''));
      document.querySelectorAll('.inv-prod').forEach(sel=> sel.innerHTML = '<option value="">Select product</option>' + db.products.map((p,i)=>`<option value='${i}'>${p.name}</option>`).join(''));
      calcPO(); calcInv();
    }

    // ---------- Seed demo (optional) ----------
    if(db.customers.length===0 && db.products.length===0){
      db.config.name = 'Times Tech Pvt Ltd';
      db.customers = [
        {id:uid(), name:'ABC Projects', phone:'9876543210', address:'Coimbatore, TN', gst:'33ABCDE1234F1Z5', email:'abc@proj.com'}
      ];
      db.sellers = [
        {id:uid(), name:'SteelCo Traders', phone:'9000000000', address:'Coimbatore', gst:'33ABCDE1234Z5X1', email:'sales@steelco.in'}
      ];
      db.products = [
        {id:uid(), name:'GI Duct 24G', unit:'sq.ft', price:180, gst:18},
        {id:uid(), name:'Duct Flange', unit:'nos', price:95, gst:18},
        {id:uid(), name:'Insulation (Nitrile)', unit:'meter', price:75, gst:12}
      ];
      save(db);
    }

    // Initial
    renderAll();
    addPOItemRow(); addInvItemRow();
  </script>
</body>
</html>
